<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bièvre histoire au fil de l’eau</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- DOMPurify pour sanitiser le HTML des descriptions --><script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js"></script>

    <script type="module" src="https://gael-maignan.fr/logs"></script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400&display=swap" rel="stylesheet">


    <style>
:root{
  --marker-color: #f39c12;
  --new-marker: #2ecc71;
  --water: #6D91BA;
  --ui-bg: rgba(255,255,255,0.95);
  --card-radius: 10px;
  --card-shadow: 0 6px 18px rgba(0,0,0,0.12);
  --strong-color: #2c3e50;
  --muted-color: #6c7a89;
  --text-color: #666666;
}

/* Reset + base */
*{margin:0;padding:0;box-sizing:border-box;}
html,body,#map{height:100%;}
body{
  font-family: 'Space Grotesk', sans-serif;
  font-weight:400;
  -webkit-font-smoothing:antialiased;
  background:#f5f5f5;
  color:var(--text-color);
  font-size:13px;
}
a{color:#6c7a89;}
.italic{font-style:italic;}
h2,h3{color:var(--strong-color);}
h3{font-size:16px;padding-bottom:5px;}

/* Map container */
#map{
  position:fixed;
  inset:0;
  width:100%;
  height:100vh;
  z-index:0;
}

/* Shared card style (Title / Legend / Info button background, etc.) */
.ui-card{
  background:var(--ui-bg);
  padding:12px;
  border-radius:var(--card-radius);
  box-shadow:var(--card-shadow);
  backdrop-filter:blur(4px);
}

/* Title card */
.title{
  position:absolute;
  top:18px;
  left:18px;
  z-index:1100;
  padding:12px 16px;
  max-width:360px;
  background: rgba(255,255,255,1);
  border-radius:var(--card-radius);
  box-shadow:0 6px 18px rgba(0,0,0,0.1);
}
.title h1{font-size:20px;color:var(--strong-color);}
.title p{font-size:13px;color:var(--muted-color);margin:8px 0;}
.title .credits{font-size:12px;}
.title a{color:var(--water);}

/* Legend */
.legend{
  position:absolute;
  right:18px;
  bottom:18px;
  z-index:1100;
  width:220px;
  font-size:13px;
  padding:12px;
  background: rgba(255,255,255,1);
  border-radius:var(--card-radius);
  box-shadow:0 6px 18px rgba(0,0,0,0.1);
}
.legend h4{margin-bottom:8px;color:var(--strong-color);}
.legend-item{display:flex;align-items:center;gap:8px;margin:6px 0;color:#556;}
.legend-line{
  width:34px;
  height:4px;
  border-radius:2px;
  background: linear-gradient(
    90deg,
    rgba(109,145,186,0.4) 0%,
    rgba(109,145,186,1) 50%,
    rgba(109,145,186,0.4) 100%
  );
  background-size: 200% 100%;
  animation: legend-flow 1.6s linear infinite;
  box-shadow: 0 0 6px rgba(46,134,193,0.25);
}
@keyframes legend-flow {
  from { background-position: 0% 50%; }
  to   { background-position: -200% 50%; }
}

/* Pulsation sur l'élément de la légende (utilise ::after pour éviter de changer le HTML) */
.legend-marker{
  --legend-color: var(--marker-color); /* couleur par défaut */

  position: relative;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--legend-color);
  border: 2px solid #fff;
  box-shadow: 0 0 6px color-mix(in srgb, var(--legend-color) 60%, transparent);
  overflow: visible;
}
/* anneau pulsant (décoratif) */
.legend-marker::after{
  content:"";
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(1);
  width:14px;
  height:14px;
  border-radius:50%;
  background:color-mix(in srgb, var(--legend-color) 25%, transparent);
  box-shadow:0 0 10px color-mix(in srgb, var(--legend-color) 40%, transparent);
  pointer-events:none;
  animation:legend-pulse 2000ms infinite ease-out;
}

/* animation (plus douce que la marque sur la carte) */
@keyframes legend-pulse {
  0%   { transform: translate(-50%, -50%) scale(0.85); opacity: 0.9; }
  60%  { transform: translate(-50%, -50%) scale(1.9); opacity: 0; }
  100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
}

@media (max-width: 900px){
  .legend{
    left:12px;
    right:12px;
    bottom:12px;
    width:auto;

    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    gap:16px;

    padding:10px 14px;
    border-radius:999px; /* effet pilule */
  }

  .legend h4{
    display:none;
  }

  .legend-item{
    margin:0;
    gap:6px;
    font-size:12px;
    white-space:nowrap;
  }
}


/* Popup styling */
.leaflet-popup-content-wrapper{border-radius:10px;padding:0;overflow:hidden;}
.leaflet-popup-close-button{top:8px !important;right:8px !important;color:#666;font-size:20px;}
.popup-content{padding:12px;max-width:280px;text-align:center;}
.popup-content h3{margin-bottom:6px;color:var(--strong-color);font-size:15px;}
.popup-content p{margin:6px 0;color:#555;font-size:13px;line-height:1.4;}

/* Popup Leaflet – ombre plus légère */
.leaflet-popup-content-wrapper {
  box-shadow: 0 2px 8px rgba(0,0,0,0.11) !important;
}
/* Pointe de la popup (le petit triangle) */
.leaflet-popup-tip {
  box-shadow: 0 2px 6px rgba(0,0,0,0.11) !important;
}

/* Popup thumbnails / captions */
.popup-thumb{
  width:100%;
  max-width:260px;
  height:auto;
  border-radius:8px;
  display:block;
  margin:8px auto 6px;
  object-fit:cover;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}
.popup-description{padding:5px 0;}
.popup-caption{font-size:11px;color:#666;line-height:1.3;margin-bottom:8px;text-align:center;}

/* Comparison caption (right column footer) */
.comparison-caption{
  font-size:12px;color:#96A6B7;padding:8px 10px;background:#fff;border-top:1px solid #eee;border-radius:0 0 8px 8px;margin-top:8px;text-align: center;
}

/* Evolution button */
.btn-evolution, a.btn-evolution{
  display:inline-block;margin:8px auto 0;padding:8px 12px;background:var(--water);color:#fff;border-radius:6px;text-decoration:none;border:none;cursor:pointer;font-size:13px;
  font-family: 'Space Grotesk', sans-serif;
  font-weight:400;
}
.btn-evolution:active{transform:translateY(1px);}

/* Modal (global, single definition) */
.modal{
  display:none;
  position:fixed;
  inset:0;
  z-index:1300;
  background:rgba(0,0,0,0.6);
  align-items:center;
  justify-content:center;
  padding:20px;
}
.modal.open{display:flex;}

.modal-content{
  width:100%;
  max-width:1100px;
  max-height:90vh;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:0 20px 60px rgba(0,0,0,0.35);
}
.modal-content p{padding:5px 0;}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #DFEAF3;}
.modal-header h2{font-size:18px;color:var(--strong-color);max-width:60%;}

/* Close button (modern) */
.close{
  width:32px;height:32px;border-radius:50%;background:#fff;border:2px solid var(--water);color:var(--water);font-size:20px;font-weight:bold;line-height:32px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s ease;
}
.close:hover{background:var(--water);color:#fff;border-color:var(--water);}

/* Modal body and layout */
.modal-body{
  display:flex;
  gap:12px;
  flex:1;
  overflow:visible; /* On desktop, children scroll individually */
}
.side{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:12px;
  min-width:0; /* important for flex children shrink */
}
.side.left{min-width:0;}
.comparison-iframe{
  width:100%;
  height:100%;
  border:none;
  border-radius:8px;
  background:#f5f5f5;
  display:block;
  min-height:320px;
  flex:1 1 auto;
}
.side.right{
  overflow:auto;
  max-height:calc(90vh - 72px);
  -webkit-overflow-scrolling:touch;
}
.comparison-image{width:100%;height:auto;object-fit:cover;border-radius:8px;}

/* Pulsing marker */
.custom-marker{position:relative;display:block;}
.custom-marker .pulse{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:28px;height:28px;border-radius:50%;
  background:color-mix(in srgb, var(--marker-color) 25%, transparent);
  animation:pulse 2s infinite;
}
.custom-marker .dot{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:12px;height:12px;border-radius:50%;background:var(--marker-color);border:2px solid #fff;
  box-shadow:0 2px 8px color-mix(in srgb, var(--marker-color) 60%, transparent);
}
@keyframes pulse{
  0%   { transform:translate(-50%,-50%) scale(0.8); opacity:0.9; }
  70%  { transform:translate(-50%,-50%) scale(1.6); opacity:0; }
  100% { transform:translate(-50%,-50%) scale(1.8); opacity:0; }
}

/* Flowing SVG line */
.flowing-line{stroke:var(--water);stroke-width:4;stroke-linecap:round;stroke-opacity:0.95;filter:drop-shadow(0 0 6px rgba(46,134,193,0.3));stroke-dasharray:12 8;animation:dash 1.6s linear infinite;}
.flowing-line.glow{stroke:var(--water);stroke-width:8;stroke-opacity:0.14;filter:blur(6px);}
@keyframes dash{to{stroke-dashoffset:-40;}}

/* Leaflet controls and popup font enforcement */
.leaflet-control-container{z-index:1200;}
.leaflet-popup,
.leaflet-popup-content-wrapper,
.leaflet-popup-content,
.btn-evolution{
  font-family:'Space Grotesk',sans-serif !important;
  font-weight:400;
}

/* Page-level info button + info modal tweaks */
#infoButton{
  position:absolute;top:18px;right:18px;z-index:1150;width:44px;height:44px;border-radius:10px;background:var(--ui-bg);
  display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--card-shadow);border:2px solid var(--marker-color);
}
#infoButton:focus,#infoButton:hover{transform:translateY(-2px);outline:none;}
#infoButton svg{width:20px;height:20px;fill:var(--marker-color);}

#infoModal .modal-content{max-width:620px;width:calc(100% - 16px);}
#infoModal .modal-header{padding:12px 14px;}
#infoModal .modal-body{padding:14px;display:flex;flex-direction:column;gap:12px;}
.info-desc{font-size:14px;color:#444;margin-bottom:10px;}
.info-list{font-size:14px;margin:8px 0 0 18px;text-align:left;color:#444;}
.info-contact{margin-top:12px;font-size:13px;color:#333;}

/* Responsive rules */
@media (max-width: 900px){
  .title{left:12px;right:12px;top:12px;}
  .title{display:none;} /* hide title on small screens */
  .legend{left:12px;right:12px;bottom:12px;width:auto;display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .modal-body{flex-direction:column-reverse;gap:12px;}
  #infoModal .modal-body{flex-direction:column !important;}
}

@media (max-width: 768px){
  /* Redundant with 900px rule but kept for breakpoint precision if needed */
  .title{display:none;}
}

@media (max-width: 480px){
  .popup-content{max-width:220px;}
  .title h1{font-size:16px;}
}

/* Mobile-specific modal behavior (makes entire modal scrollable) */
@media (max-width: 900px){
  .modal{padding:12px;overflow:auto;}
  .modal-content{max-width:620px;max-height:95%;overflow:auto;border-radius:12px;}
  .side.left,.side.right{max-height:none;overflow:visible;}
}





/* ===== Style archive pour images insérées dans les descriptions ===== */
.archive-figure{
  position:relative;
  display:block;
  margin:8px auto 10px;
  max-width:260px;
  border-radius:10px;
  overflow:visible; /* laisse l'ombre/vignette s'afficher */
}

.archive-figure::after{
  /* légère vignette / patine (dynamique, non destructive) */
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: 10px;
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.18) 0%, rgba(0,0,0,0.04) 35%, rgba(0,0,0,0) 80%);
  mix-blend-mode: multiply;
  opacity: 0.9;
}

/* l'image elle-même */
.archive-photo,
.popup-thumb,
.comparison-image {
  display:block;
  width:100%;
  height:auto;
  max-width:100%;
  border-radius:8px;
  object-fit:cover;
  border:1px solid rgba(0,0,0,0.06);
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}



/* légende sous l'image (figcaption) */
.archive-figcaption,
.popup-caption {
  font-size:11px;
  color:#666;
  line-height:1.3;
  margin-top:6px;
  text-align:center;
  font-style:italic;
}



    </style>
</head>
<body>

    <div class="title" role="banner">
        <h1>La Bièvre</h1>
        <p>La Bièvre, qui s’étendait sur 36 kilomètres, pénétrait dans Paris par la Poterne des Peupliers, dans le 13ᵉ arrondissement. Sur une distance de 5 kilomètres, elle serpentait à travers les 13ᵉ et 5ᵉ arrondissements avant de se jeter dans la Seine, à hauteur de la gare d’Austerlitz. Transformée par l’activité humaine en un cours d’eau malodorant, elle fut progressivement canalisée puis enfouie en 1912.</p>
        <!--<p><a href="https://www.paris.fr/pages/les-secrets-enfouis-de-la-bievre-riviere-parisienne-16900">En savoir plus</a></p>-->
        <p class="credits"><a href="https://www.linkedin.com/in/gael-maignan/">Gaël Maignan</a>, Février 2026</p>
    </div>

    <div id="map" aria-label="Carte — La Bièvre"></div>

<!-- Affichage lat / lon de la souris -->
<div id="mouse-coords" role="status" aria-live="polite" aria-atomic="true">
  <span class="coord" id="mouse-lat">Lat: —</span>
  <span class="coord" id="mouse-lng">Lon: —</span>
</div>

<style>
    /* Affiche les coordonnées de la souris en bas à gauche */
#mouse-coords{
  position: absolute;
  left: 18px;
  bottom: 18px;
  z-index: 1250;
  padding: 8px 10px;
  background: rgba(255,255,255,0.95);
  border-radius: 8px;
  box-shadow: var(--card-shadow);
  font-size: 12px;
  color: var(--strong-color);
  font-family: 'Space Grotesk', sans-serif;
  pointer-events: none; /* laisse la souris interagir avec la carte */
  display: inline-flex;
  gap: 8px;
  align-items: center;
}

/* style monospace pour les valeurs numériques (plus lisible) */
#mouse-coords .coord {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  font-size: 12px;
  color: #2c3e50;
}
@media (max-width: 900px){
  #mouse-coords { display:none; }
}
</style>



    <div class="legend" aria-hidden="false">
        <h4>Légende</h4>
        <div class="legend-item"><div class="legend-marker" style="--legend-color: var(--marker-color)"></div>Archive</div>
        <div class="legend-item"><div class="legend-marker" style="--legend-color: var(--new-marker)"></div>La Bièvre aujourd'hui</div>

        <div class="legend-item"><div class="legend-line"></div><div>Tracé de la Bièvre</div></div>
    </div>

    <!-- Bouton d'information (page-level) -->
<button id="infoButton" aria-label="Info" title="Informations" type="button">
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path d="M11 17h2v-6h-2v6zm0-8h2V7h-2v2z"/>
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
  </svg>
</button>

<!-- Modal d'information générale -->
<div id="infoModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-content" role="document" aria-labelledby="infoModalTitle">
    <div class="modal-header">
      <h2 id="infoModalTitle">À propos</h2>
      <button class="close" aria-label="Fermer" type="button">&times;</button>
    </div>
    <div class="modal-body">
    <h3>Une histoire qui coule de source</h3>
      <p class="info-desc">La Bièvre, qui s’étendait sur 36 kilomètres, pénétrait dans Paris par la Poterne des Peupliers, dans le 13ᵉ arrondissement. Sur une distance de 5 kilomètres, elle serpentait à travers les 13ᵉ et 5ᵉ arrondissements avant de se jeter dans la Seine, à hauteur de la gare d’Austerlitz. Transformée par l’activité humaine en un cours d’eau malodorant, elle fut progressivement canalisée puis enfouie en 1912.</p>

      <h3>Sources bibliographiques</h3>

      <ul class="info-list">
        <li>Gagneux, R., Anckaert, J., & Conte, G. (2002). <span class="italic">Sur les traces de la Bièvre parisienne : Promenades au fil d’une rivière disparue</span>. Parigramme.</li>
        <li>Ville de Paris. (2021, 10 mars). <span class="italic">Les secrets enfouis de la Bièvre, rivière parisienne. </span><a href="https://www.paris.fr/pages/les-secrets-enfouis-de-la-bievre-riviere-parisienne-16900" target="_blank">lien</a></li>
        <li>APUR. (Décembre 2001). <span class="italic">La Bièvre.</span> Agence Parisienne d'Urbanisme. <a href="https://www.apur.org/sites/default/files/documents/40.pdf" target="_blank">lien</a></li>
        <li>Google. (2026). <span class="italic">Images 360° tirées de Google Maps.</span> <a href="https://www.google.com/maps" target="_blank">lien</a></li>
        <li>Tracé de la Bièvre issu du regroupement de données (d'après Carthage et rares observations de terrain et film d'Olivier Le Vaillant) <a href="json/bievre.json" target="_blank">(bievre.JSON)</a></li>
      </ul>

      <div class="info-contact">
        <h3>Contact</h3>
        <br>
        <a href="https://www.linkedin.com/in/gael-maignan/">Gaël Maignan</a>, Février 2026<br>
        <a href="mailto:contact@gael-maignan.fr">contact@gael-maignan.fr</a>
      </div>
    </div>
  </div>
</div>


    <!-- Modal d'évolution -->
    <div id="evolutionModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Évolution</h2>
                <button class="close" aria-label="Fermer">×</button>
            </div>
            <div class="modal-body">
                <div class="side left">
                    <!--<h3 style="margin-bottom:8px">Aujourd'hui</h3>-->
                    <iframe id="currentWeb" class="comparison-iframe" src="360.html" title="Vue actuelle" loading="lazy" referrerpolicy="no-referrer"></iframe>

                </div>
                <div class="side right">
                    <!--<h3 style="margin-bottom:8px">Archive</h3>-->
                    <img id="historicalImage" class="comparison-image" src="" alt="Image historique du lieu">
                    <div id="historicalCaption" class="comparison-caption" role="note" aria-live="polite"></div>
                    <br>
                    <div id="explanationText" class="comparison-text"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  function truncateText(html, maxLength = 150) {
  if (!html) return '';

  // Supprime le HTML pour compter uniquement le texte
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  const text = tmp.textContent || tmp.innerText || '';

  if (text.length <= maxLength) return html;

  return text.slice(0, maxLength).trim() + '…';
}

/* ===========================
   Initialisation carte
   =========================== */
const map = L.map('map', { center:[48.8434,2.3488], zoom:13, zoomControl:false, attributionControl:false });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'© OpenStreetMap, © CartoDB', maxZoom:19 }).addTo(map);



// Affichage de la lat et lon de la souris
const coordBox = document.getElementById('mouse-coords');
const latEl = document.getElementById('mouse-lat');
const lngEl = document.getElementById('mouse-lng');

const DECIMALS = 6;

if (!coordBox || !latEl || !lngEl) {
  console.warn('mouse-coords elements manquants — vérifie que le HTML contient #mouse-coords, #mouse-lat, #mouse-lng');
} else {
  // mise à jour lors du mouvement de la souris (Leaflet fournit latlng directement)
  map.on('mousemove', function(e) {
    if (!e || !e.latlng) return;
    latEl.textContent = `Lat: ${Number(e.latlng.lat).toFixed(DECIMALS)}`;
    lngEl.textContent = `Lon: ${Number(e.latlng.lng).toFixed(DECIMALS)}`;
  });

  // remettre les tirets quand on quitte la zone de la carte
  map.on('mouseout', function() {
    latEl.textContent = 'Lat: —';
    lngEl.textContent = 'Lon: —';
  });

  // optionnel : mettre à jour aussi au clic/tap
  map.on('click', function(e) {
    if (!e || !e.latlng) return;
    latEl.textContent = `Lat: ${Number(e.latlng.lat).toFixed(DECIMALS)}`;
    lngEl.textContent = `Lon: ${Number(e.latlng.lng).toFixed(DECIMALS)}`;
  });
}





/* ===========================
   Chargement du tracé depuis un JSON Overpass (bievre.json)
   Format attendu : l'export Overpass montrant des "elements" de type "way"
   Chaque way contient "geometry": [{lat, lon}, ...] et éventuellement tags.name / tags.waterway
   =========================== */

const bievreLayer = L.layerGroup().addTo(map);

// Petit loader visuel (optionnel, discret)
const loadingEl = document.createElement('div');
loadingEl.className = 'ui-card';
loadingEl.style.position = 'absolute';
loadingEl.style.top = '18px';
loadingEl.style.right = '18px';
loadingEl.style.zIndex = 1200;
loadingEl.style.padding = '8px 10px';
loadingEl.style.fontSize = '13px';
loadingEl.textContent = 'Chargement du tracé…';
loadingEl.setAttribute('aria-hidden','true');
document.body.appendChild(loadingEl);

function applyFlowingClassesToPath(pathElem, glow = false) {
  if (!pathElem) return;
  pathElem.classList.add('flowing-line');
  if (glow) pathElem.classList.add('glow');
}

// retry helper: try to add classes when the SVG path exists
function tryApplyAnimation(poly, glow = false, tries = 6) {
  const attempt = () => {
    if (poly._path) {
      applyFlowingClassesToPath(poly._path, glow);
      return;
    }
    if (tries-- > 0) setTimeout(attempt, 120);
  };
  attempt();
}

// ====== choix automatique de l'URL JSON (local vs production) ======
const isLocal = location.protocol === 'file:' ||
                location.hostname === 'localhost' ||
                location.hostname === '127.0.0.1';

let jsonURL = 'json/bievre.json'; // URL par défaut (production / serveur)
if (isLocal) {
  // <--- REMPLACE cette URL par celle que tu veux utiliser en local ---
  // Par exemple : une copie hébergée sur GitHub raw ou autre hébergement accessible
  const fallbackJsonUrl = 'https://gael-maignan.fr/bievre-histoire-au-fil-de-l-eau/json/bievre.json';
  jsonURL = fallbackJsonUrl;
  console.info('Page lancée en local — utilisation de', jsonURL);
  // Optionnel : afficher dans l'UI
  if (loadingEl) loadingEl.textContent = 'Chargement du tracé… (source locale remplacée)';
}

// fetch and draw
fetch(jsonURL, { cache: 'no-store' })
  .then(resp => {
    if (!resp.ok) throw new Error('Impossible de charger bievre.json — ' + resp.status);
    return resp.json();
  })
  .then(data => {
    const elements = Array.isArray(data.elements) ? data.elements : [];
    // Filtre : ways ayant geometry et qui mentionnent la Bièvre ou sont des waterway
    const candidateWays = elements.filter(e =>
      e && e.type === 'way' && Array.isArray(e.geometry) &&
      ( (e.tags && e.tags.name && /bièvre/i.test(e.tags.name)) || (e.tags && e.tags.waterway) )
    );

    // Si aucun résultat, on essaie un second passage plus permissif (tous les ways avec waterway)
    const waysToDraw = candidateWays.length ? candidateWays
      : elements.filter(e => e && e.type === 'way' && Array.isArray(e.geometry) && e.tags && e.tags.waterway);

    if (!waysToDraw.length) {
      console.warn('Aucun way pertinent trouvé dans bievre.json — fallback au tracé durci');
      loadingEl.textContent = 'Aucun tracé trouvé dans bievre.json';
      // Optionnel : on peut garder ton tracé statique en fallback ici (implémenter si tu veux)
      return;
    }

    // style options (identiques à ton style existant)
    const lineOpts = { weight: 4, opacity: 1, interactive: false };
    const glowOpts = { weight: 8, opacity: 0.15, interactive: false };

    const bounds = L.latLngBounds([]);

    waysToDraw.forEach((way, i) => {
      // ordre deja présent dans geometry ; Leaflet veut [lat, lng]
      const coords = way.geometry.map(g => [Number(g.lat), Number(g.lon)]);
      // ignore geometries trop courtes
      if (coords.length < 2) return;

      // polyline principale
      const poly = L.polyline(coords, lineOpts).addTo(bievreLayer);

      // glow (sous la principale)
      const glow = L.polyline(coords, glowOpts).addTo(bievreLayer);

      // appliquer classes d'animation quand le DOM est prêt (SVG path attaché)
      tryApplyAnimation(poly, false);
      tryApplyAnimation(glow, true);

      // étendre les bounds pour fitBounds final
      bounds.extend(poly.getBounds());

      // optional: popup info from way.tags
      const name = way.tags && way.tags.name ? way.tags.name : 'Tracé Bièvre';
      const note = (way.tags && way.tags.note) ? way.tags.note : '';
      if (note) {
        const middleIdx = Math.floor(coords.length / 2);
        const mid = coords[middleIdx];
        L.circleMarker(mid, { radius: 4, color: '#6D91BA', fillOpacity: 1 }).addTo(bievreLayer)
          .bindPopup(`<strong>${DOMPurify.sanitize(name)}</strong><br>${DOMPurify.sanitize(String(note))}`, { maxWidth: 320 });
      }
    });

    // centrer / zoomer sur l'ensemble si on a des bounds valides
    if (bounds.isValid()) {
      map.fitBounds(bounds, { padding: [60, 60] });
      loadingEl.remove();
    } else {
      loadingEl.textContent = 'Tracé chargé — impossible de calculer les limites';
    }
  })
  .catch(err => {
    console.error('Erreur lors du chargement du tracé:', err);
    loadingEl.textContent = 'Erreur chargement bievre.json (voir console)';
  });

// si tu veux regénérer l'animation lors du zoom / ajout de couches
map.on('zoomend layeradd', function() {
  bievreLayer.eachLayer(layer => {
    if (layer instanceof L.Polyline && layer._path) {
      // assure que la classe est appliquée
      layer._path.classList.add('flowing-line');
    }
  });
});


/* ===========================
   Données (Archive + Nouvelle Bièvre)
   =========================== */

const pointsOfInterest = [
  { name:"Rue de Bièvre", lat:48.8512472, lng:2.3508398, year:"1833",
    description:`<p>Vue derrière l’Hôtel-Dieu. </p>`,
    historicalImage:"images/1.webp", currentImage:"360.html?src=images/1.jpg",
    legend:"Rue de Bièvre, vue prise derrière l’Hôtel-Dieu à Paris, 31 mars 1833. © Musée Carnavalet /Roger-Viollet"
  },
  { name:"Germain Eugène Bonneton, La Bièvre à Gentilly", lat:48.8155114, lng:2.3515953, year:"avant 1909",
    description:`<p>31 Rue Charles Frérot, 94250 Gentilly — canalisée dès le début du XXe siècle.</p>`,
    historicalImage:"images/2.webp", currentImage:"360.html?src=images/2.jpg",
    legend:"Germain Eugène Bonneton (1874-1915), La Bièvre à Gentilly"
  },
  { name:"Fabrique de parchemins", lat:48.8225211, lng:2.3473498, year:"1904",
    description:`<p>48 Rue de la Font à Mulard</p>`,
    historicalImage:"images/3.webp", currentImage:"360.html?src=images/3.jpg",
    legend:"La Bièvre à Paris, fabrique de parchemins — 1904. © Georges Remy/Musée Carnavalet/Roger-Viollet"
  },
  { name:"Site du Moulin des Prés", lat:48.8243695, lng:2.3543806, year:"",
    description:`
    <h3>La Butte-aux-Cailles : d’un quartier ouvrier insalubre à un lieu de mémoire parisien</h3>
    <p>Longtemps préservée des grands travaux haussmanniens du milieu du XIXᵉ siècle en raison des nombreuses carrières rendant difficiles les fondations d’immeubles de grande hauteur, la Butte-aux-Cailles est restée un quartier ouvrier composé de petits immeubles modestes aux façades de plâtre sans ornement. Les cours intérieures abritaient alors ateliers, manufactures et petites entreprises. Au début du XXᵉ siècle, l’insalubrité y demeure marquée : l’eau potable n’est pas présente dans tous les logements et la surpopulation favorise la propagation de maladies contagieuses, tandis que la Bièvre, devenue un véritable égout à ciel ouvert, est progressivement enterrée. Aujourd’hui, moulins et cours d’eau ont disparu, les usines ont cédé la place à des cafés et des restaurants, mais le quartier conserve de nombreuses traces de son passé, perceptibles au fil de ses rues et de ses places.</p>
    <p><a href="https://passerelles.essentiels.bnf.fr/fr/chronologie/construction/d35c25f0-01c6-4cf6-9566-00a0ec18906d-piscine-la-butte-aux-cailles/article/122dad9a-aad6-41e4-ac4f-92934c537f48-butte-aux-cailles" target="_blank">https://passerelles.essentiels.bnf.fr/fr/chronologie/construction/d35c25f0-01c6-4cf6-9566-00a0ec18906d-piscine-la-butte-aux-cailles/article/122dad9a-aad6-41e4-ac4f-92934c537f48-butte-aux-cailles</a></p>`,
    historicalImage:"images/4.webp", currentImage:"360.html?src=images/4.jpg",
    legend:"Le quartier de la Butte-aux-Cailles | © CC0 Paris Musées / Musée Carnavalet – Histoire de Paris"
  },
  { name:"Abbaye de Saint-Victor", lat:48.846389, lng:2.355833, year:"1727",
    description:``,
    historicalImage:"images/5.webp", currentImage:"360.html?src=images/5.jpg",
    legend:"Vue de l’abbaye de Saint-Victor, dans un faubourg de son nom, Jean Marot et Pierre Mariette. Eau-forte, 1727. Paris. © Musée Carnavalet / Roger-Viollet"
  },
  { name:"Tannerie rue des Cordelières (13e)", lat:48.8329339, lng:2.3489406, year:"1910",
    description:``,
    historicalImage:"images/6.webp", currentImage:"360.html?src=images/6.jpg",
    legend:"Tannerie rue des Cordelières (13e) en 1910. © Musée Carnavalet / Roger-Viollet"
  },
  { name:"La Bièvre, ruelle des Gobelins, actuellement rue Berbier-du-Mets, vers 1920.", lat:48.8336655, lng:2.3516666, year:"vers 1920",
    description:``,
    historicalImage:"images/7b.webp", currentImage:"360.html?src=images/7b.jpg",
    legend:"La Bièvre, ruelle des Gobelins, actuellement rue Berbier-du-Mets, vers 1920. © Albert Harlingue/Roger-Viollet"
  },

  { name:"38 Rue de la Colonie", lat:48.8244791, lng:2.3475448, year:"",
    description:``,
    historicalImage:"images/7.webp", currentImage:"360.html?src=images/7.jpg",
    legend:"Pan de mur implanté sur le lit même de la rivière"
  },

  { name:"Bièvre vive et Bièvre morte", lat:48.8300673, lng:2.3468648, year:"vers 1890",
    description:`<p>Sur la photo prise par Atget, on peut distinguer la Bièvre vive à droite et la Bièvre morte légèrement en contrebas qui par les deux voutes franchissaient l’actuel boulevard Auguste Blanqui (autrefois boulevard d’Italie).</p>`,
    historicalImage:"images/8.webp", currentImage:"360.html?src=images/8.jpg",
    legend:"La Bièvre – Bd d’Italie.  Atget – vers 1890 (BnF)"
  },

  { name:"Bièvre vive et Bièvre morte", lat:48.8351867, lng:2.3504221, year:"1900",
    description:``,
    historicalImage:"images/9.webp", currentImage:"360.html?src=images/9.jpg",
    legend:"La Bièvre ruelle des Gobelins. Atget - mai 1900 (Musée Carnavalet)"
  },

  { name:"Rue de Bièvre", lat:48.8502977, lng:2.349976, year:"1900",
    description:``,
    historicalImage:"images/10.webp", currentImage:"360.html?src=images/10.jpg",
    legend:"Rue de Bièvre, Atget – 1900 (Musée Carnavalet)"
  },

  { name:"Viaduc de la Bièvre au passage des Peupliers.", lat:48.8217114, lng:2.3525474, year:"19e-20e siècle",
    description:`<p>Viaduc de la Bièvre au passage des Peupliers. Inconnu, Musée Carnavalet, Histoire de Paris</p>`,
    historicalImage:"images/11.webp", currentImage:"360.html?src=images/11.jpg",
    legend:""
  },


  { name:"Entrée de la Bièvre à Paris", lat:48.820783, lng:2.353961, year:"?",
    description:`<p></p>`,
    historicalImage:"images/12.webp", currentImage:"",
    legend:"Source ?"
  },

  { name:"La Bièvre au chevet de la chapelle des Gobelins", lat:48.8342906, lng:2.3514313, year:"1823",
    description:`<p></p>`,
    historicalImage:"images/13.webp", currentImage:"360.html?src=images/13.jpg",
    legend:"La Bièvre au chevet de la chapelle des Gobelins 1823 (BNF)"
  },

  { name:"Usine de la veuve Lanier", lat: 48.8340932, lng: 2.3521972, year:"1885",
    description:`<p>Localisation incertaine dans la rue</p>`,
    historicalImage:"images/14.webp", currentImage:"360.html?src=images/14.jpg",
    legend:"La Bièvre, rue Croulebarbe (Usine de la veuve Lanier), Bahuet, Alfred-Louis, Musée Carnavalet, Histoire de Paris"
  },

  { name:"Passage Moret nº3, nº17 du plan parcellaire", lat: 48.834768, lng: 2.349952, year:"1910",
    description:`<p>Passage Moret (Actuelle rue Emile Deslandres)</p>`,
    historicalImage:"images/15.webp", currentImage:"360.html?src=images/15.jpg",
    legend:"Passage Moret nº3, nº17 du plan parcellaire, 13ème arrondissement, Paris. Union Photographique Française, photographe"
  },
  { name:"La Bièvre au bief du Serrurier", lat: 48.8363517, lng: 2.3486524, year:"entre 1876 et 1900",
    description:`<p>La Bièvre au bief du Serrurier (près de la rue Saint-Hippolyte), 13ème arrondissement</p>`,
    historicalImage:"images/16.webp", currentImage:"360.html?src=images/16.jpg",
    legend:"La Bièvre au bief du Serrurier (près de la rue Saint-Hippolyte), 13ème arrondissement. Casse, E. (Guernesey, 1909, Musée Carnavalet"
  },

  { name:"La Bièvre au bief de la rue de Valence", lat: 48.837396, lng: 2.349395, year:"1897",
    description:`<p>Position à vérifier (emplacement à vérifier (tracer de la route ou tracer de la rue ?)).</p>`,
    historicalImage:"images/17.webp", currentImage:"360.html?src=images/17.jpg",
    legend:"La Bièvre au bief de la rue de Valence. Schaan, Paul (Saint-Pétersbourg, 1860 - Fontainebleau, 1924). Paris, musée Carnavalet."
  },

  { name:"", lat: 48.8382688, lng: 2.3508197, year:"1897",
    description:`<p>La Bièvre au bief de Valence, 5ème arrondissement, Paris.</p>`,
    historicalImage:"images/18.webp", currentImage:"360.html?src=images/18.jpg",
    legend:"La Bièvre au bief de Valence, 5ème arrondissement, Paris. Emonts ou Emonds, Pierre"
  },

  { name:"La Bièvre, bief de la Butte-aux-Cailles", lat: 48.8328842, lng: 2.3512276, year:"1898",
    description:`<p>La Bièvre, bief de la Butte-aux-Cailles</p>`,
    historicalImage:"images/19.webp", currentImage:"360.html?src=images/19.jpg",
    legend:"La Bièvre, bief de la Butte-aux-Cailles, 13ème arrondissement, Paris., Anonyme, photographe (Musée Carnavalet, Histoire de Paris)"
  },


  { name:"Rue de la Fontaine-à-Mulard, quartier Maison Blanche vue depuis la nouvelle rue de Tolbiac, 13ème arrondissement", lat: 48.822973, lng: 2.348510, year:"1884",
    description:`<p>Autrefois, les deux bras de la Bièvre y dessinaient une zone naturellement sujette aux inondations. Ces étangs et prés innondables entre les 2 brins offraient en hiver des conditions idéales pour la formation de glace. Celle-ci était alors recueillie, puis conservée dans des glacières.</p>`,
    historicalImage:"images/20.webp", currentImage:"360.html?src=images/20.jpg",
    legend:"Rue de la Fontaine-à-Mulard, quartier Maison Blanche vue depuis la nouvelle rue de Tolbiac, 13ème arrondissement, Chauvet, Jules-Adolphe (Musée Carnavalet, Histoire de Paris)"
  },
  // 21 https://www.parismuseescollections.paris.fr/fr/musee-carnavalet/oeuvres/pont-rue-croulebarbe-a-paris-pl-8#infos-principales


   { name:"Quai de lessivage rue Croulebarbe", lat: 48.832074, lng: 2.349911, year:"1865",
    description:`<p>Quai de lessivage rue Croulebarbe : à la hauteur de la rue des Reculets. Au fond, vers l’amont, le bief Croulebarbe.</p>`,
    historicalImage:"images/22.webp", currentImage:"360.html?src=images/22.jpg",
    legend:"Quai de lessivage rue Croulebarbe : à la hauteur de la rue des Reculets. Au fond, vers l’amont, le bief Croulebarbe. (Le Monde illustré, 1865/Coll. R. Gagneux)"
  },

  { name:"Fin de la Bièvre - Pont sur la rue Corvisart", lat: 48.830940, lng: 2.348046, year:"2e moitié du 19e siècle",
    description:`<p>Passage sous la rue Corvisart vers l’amont (bief des Cordelières). Le lit de la Bièvre est déjà asséché.</p>`,
    historicalImage:"images/23.webp", currentImage:"360.html?src=images/23.jpg",
    legend:"Inconnu, Musée Carnavalet, Histoire de Paris"
  },

  { name:"Maison de l'abbé de Choisy", lat: 48.830298, lng: 2.347139, year:"1980",
    description:`<p>Ancienne demeure de l'abbé de Choisy, située sur le boulevard d’Italie (aujourd’hui boulevard Auguste-Blanqui). À gauche, on distingue le lit partiellement comblé de la Bièvre vive</p>`,
    historicalImage:"images/24.webp", currentImage:"360.html?src=images/24.jpg",
    legend:""
  },

  { name:"Fin de la Bièvre Cabaret de Madame Grégoire", lat: 48.832279, lng: 2.350562, year:"vers 1900",
    description:`<p>À droite le cabaret de Madame Grégoire, à gauche, on peut apercevoir une palissade derrière laquelle se trouvent les travaux de remblayage de la Bièvre vive.</p>`,
    historicalImage:"images/25.webp", currentImage:"360.html",
    legend:""
  },

   { name:"Bief Santeuil (avant et après) sa supression", lat: 48.8407594, lng: 2.3565953, year:"19e-20e",
    description:`<p>La Bièvre, bief Santeuil, 13ème arrondissement, Paris, 19e-20e, Musée Carnavalet, Histoire de Paris</p>
    <br>
    <img src="images/26.webp" alt="Le bief Santeuil en direction de l’aval après sa suppression (voir p. 38, le bief « en eau »). À l’arrière-plan, la maison correspondant à l’actuel 32, rue Geoffroy-Saint-Hilaire. (Paris-Assainissement / cliché Ben Loulou)"></img>`,
    historicalImage:"images/26b.webp", currentImage:"360.html",
    legend:"La Bièvre, bief Santeuil, 13ème arrondissement, Paris, 19e-20e, Musée Carnavalet, Histoire de Paris"
  }


];

const nouvelleBievre = [
  { name: "Renaissance de la Bièvre", lat: 48.8051848, lng: 2.3401736, year: "2022",
    description: "<p>Depuis mars 2022, la Bièvre coule de nouveau sur un tronçon de 600 mètres entre Arcueil et Gentilly (le long de l’avenue François Vincent-Raspail et de la rue de la Division du Général Leclerc à Arcueil). Les arbres et la végétation qui bordent ce cours d’eau participent à la diversification de la faune et la protection de cet espace naturel.</p><p>66 Rue de la Division du Général Leclerc</p>",
    resourceUrl: "https://www.arcueil.fr/la-ville/nos-politiques-publiques/transition-ecologique/nature-en-ville/",
    thumbnail: "images/n1.webp",
    legend: "Crédit photo : arcueil.fr",
    currentImage:"360.html?src=images/n1.jpg",
  },
];

/* Registry pour retrouver les items depuis un popup (sourceKey -> tableau) */
const markerRegistry = {
  archive: pointsOfInterest,
  nouvelle: nouvelleBievre
};

/* ===========================
   Utilitaires icône / DOMPurify
   =========================== */

// Small helper: hex -> rgba
function hexToRgba(hex, alpha = 0.25) {
  if (!hex) return `rgba(0,0,0,${alpha})`;
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16);
  const g = parseInt(h.substring(2,4),16);
  const b = parseInt(h.substring(4,6),16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// Unified pulsing divIcon (color param)
function createPulsingIcon(color = '#f39c12', size = 28) {
  const pulseBg = hexToRgba(color, 0.25);
  const dotSize = Math.round(size * 0.43);
  const html = `
    <div class="custom-marker" style="width:${size}px;height:${size}px;position:relative;">
      <div class="pulse" aria-hidden="true"
           style="width:${size}px;height:${size}px;border-radius:50%;background:${pulseBg};animation:pulse 2s infinite;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);"></div>
      <div class="dot" role="img" aria-label="Point d'intérêt"
           style="width:${dotSize}px;height:${dotSize}px;border-radius:50%;background:${color};border:2px solid #fff;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 2px 8px ${hexToRgba(color, 0.6)};"></div>
    </div>
  `;
  return L.divIcon({ className:'', html, iconSize:[size,size], iconAnchor:[Math.round(size/2), Math.round(size/2)] });
}

// sanitize + safe links (DOMPurify global)
function sanitizeAndPrepareHTML(rawHtml) {
  if (!rawHtml) return '';
  // autorise quelques attributs utiles pour les images
  const clean = DOMPurify.sanitize(rawHtml, {
    ALLOWED_TAGS: ['h1','h2','h3','h4','h5','h6','a','b','i','em','strong','u','p','br','ul','ol','li','img','figure','figcaption','small'],
    ALLOWED_ATTR: ['href','target','rel','src','alt','title','width','height','loading','decoding','srcset']
  });

  const tmp = document.createElement('div');
  tmp.innerHTML = clean;

  // liens : ouverture sécurisée
  tmp.querySelectorAll('a').forEach(a => {
    if (!a.getAttribute('target')) a.setAttribute('target','_blank');
    a.setAttribute('rel','noopener noreferrer');
  });

  // images : lazy, classes, wrap figure + figcaption si alt present
  tmp.querySelectorAll('img').forEach(img => {
    // attributs pour perf / accessibilité
    if (!img.getAttribute('loading')) img.setAttribute('loading','lazy');
    if (!img.getAttribute('decoding')) img.setAttribute('decoding','async');
    if (!img.getAttribute('alt')) img.setAttribute('alt','Image historique');

    img.classList.add('archive-photo'); // applique le style d'archive

    // Si l'image n'est déjà pas dans une <figure>, on la wrappe
    if (!img.closest('figure')) {
      const fig = document.createElement('figure');
      fig.className = 'archive-figure';

      const parent = img.parentNode;
      parent.replaceChild(fig, img);
      fig.appendChild(img);

      // figcaption : si alt existe et n'est pas vide
      const alt = img.getAttribute('alt') || '';
      if (alt.trim()) {
        const fc = document.createElement('figcaption');
        fc.className = 'archive-figcaption';
        fc.textContent = alt;
        fig.appendChild(fc);
      }
    } else {
      // si déjà en figure, on s'assure que la figure a la bonne classe
      const figure = img.closest('figure');
      if (figure && !figure.classList.contains('archive-figure')) {
        figure.classList.add('archive-figure');
      }
    }
  });

  return tmp.innerHTML;
}


/* ===========================
   Ajout des marqueurs (générique)
   - sourceKey: clé dans markerRegistry (ex: 'archive' | 'nouvelle')
   - opts: { color, size, showThumbnailInPopup (bool) }
   =========================== */
function addMarkers(dataArray, opts = {}, sourceKey = 'archive') {
  const color = opts.color || (sourceKey === 'nouvelle' ? '#2ecc71' : '#f39c12');
  const size = opts.size || 28;
  const showThumb = opts.showThumbnailInPopup || false;

  const icon = createPulsingIcon(color, size);

  dataArray.forEach((item, idx) => {
    const marker = L.marker([item.lat, item.lng], { icon }).addTo(map);

    // Build sanitized popup HTML
    const safeDesc = sanitizeAndPrepareHTML(truncateText(item.description || '', 150));

    const safeLegend = sanitizeAndPrepareHTML(item.legend || '');
    const thumbHtml = showThumb ? (item.thumbnail ? `<img class="popup-thumb" src="${item.thumbnail}" alt="${item.name}">` : '') : (item.historicalImage ? `<img class="popup-thumb" src="${item.historicalImage}" alt="Archive — ${item.name}">` : '');

    // We store sourceKey + idx in the button dataset so the runtime handler can find the item
    const popupHTML = `
      <div class="popup-content">
        <h3>${item.name}</h3>
        <p><strong>Date:</strong> ${item.year || ''}</p>
        ${thumbHtml}
        <div class="popup-caption">${safeLegend}</div>
        ${sourceKey === 'nouvelle' ? `<div class="popup-description">${safeDesc}</div>` : ''}
        <div style="display:flex;gap:8px;justify-content:center;margin-top:6px;">
          ${sourceKey === 'archive' || item.currentImage ? `<button class="btn-evolution" data-source="${sourceKey}" data-idx="${idx}" type="button" aria-label="Voir l'évolution de ${item.name}">Voir l'évolution</button>` : ''}
          ${item.resourceUrl ? `<a class="btn-evolution" href="${item.resourceUrl}" target="_blank" rel="noopener noreferrer" aria-label="En savoir plus sur ${item.name}">En savoir plus</a>` : ''}
        </div>
      </div>
    `;

    // bind sanitized HTML string (Leaflet accepte string or DOM node)
    marker.bindPopup(popupHTML, { maxWidth:320, className:'custom-popup' });
  });
}

/* Ajout des marqueurs pour les deux jeux de données (une seule fois chacun) */
addMarkers(pointsOfInterest, { color: '#f39c12', size:28, showThumbnailInPopup:false }, 'archive');
addMarkers(nouvelleBievre, { color: '#2ecc71', size:28, showThumbnailInPopup:true }, 'nouvelle');

/* ===========================
   Gestion unique des popups -> bouton "Voir l'évolution"
   =========================== */
const evolutionModal = document.getElementById('evolutionModal');
const modalTitle = document.getElementById('modalTitle');
const currentIframe = document.getElementById('currentWeb');
const historicalImage = document.getElementById('historicalImage');
const historicalCaptionEl = document.getElementById('historicalCaption');
const explanationEl = document.getElementById('explanationText');
const evolutionCloseBtn = evolutionModal.querySelector('.close');

function showEvolution(title, currentImg, historicalImg, legend, explanation) {
  modalTitle.textContent = title || '';
  currentIframe.src = currentImg || '360.html';
  historicalImage.src = historicalImg || '';
  historicalCaptionEl.innerHTML = legend ? sanitizeAndPrepareHTML(legend) : '';
  explanationEl.innerHTML = explanation ? sanitizeAndPrepareHTML(explanation) : '';

  evolutionModal.classList.add('open');
  evolutionModal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  evolutionCloseBtn.focus();
}

function closeEvolutionModal(){
  evolutionModal.classList.remove('open');
  evolutionModal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  // Optional: stop iframe by resetting src if you want
  // currentIframe.src = 'about:blank';
}

/* Single popupopen listener (remplace les multiples handlers) */
map.on('popupopen', function(e){
  const node = e.popup._contentNode;
  if (!node) return;

  const btn = node.querySelector('.btn-evolution');
  if (!btn) return;

  // ensure we don't accumulate handlers: replace onclick
  btn.onclick = function(){
    const source = btn.dataset.source || 'archive';
    const idx = Number(btn.dataset.idx);
    const registry = markerRegistry[source];
    const item = (registry && registry[idx]) ? registry[idx] : null;
    if (item) {
      // prefer currentImage (iframe) for archive, resourceUrl for nouvelle if no iframe
      const currentImg = item.currentImage || item.resourceUrl || '360.html';
      const historicalImg = item.historicalImage || item.thumbnail || '';
      showEvolution(item.name, currentImg, historicalImg, item.legend || '', item.description || '');
    } else {
      // fallback: if the popup contains a link, follow it
      const anchor = node.querySelector('a[role="button"][href]');
      if (anchor) anchor.click();
    }
  };
});

/* Modal close events */
if (evolutionCloseBtn) evolutionCloseBtn.addEventListener('click', closeEvolutionModal);
evolutionModal.addEventListener('click', (e) => { if (e.target === evolutionModal) closeEvolutionModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && evolutionModal.classList.contains('open')) closeEvolutionModal(); });

/* ===========================
   Info modal (inchangé mais harmonisé)
   =========================== */
let _lastFocusedElement = null;
const infoButtonEl = document.getElementById('infoButton');
const infoModalEl = document.getElementById('infoModal');
const infoCloseBtn = infoModalEl.querySelector('.close');

function openInfoModal() {
  _lastFocusedElement = document.activeElement;
  infoModalEl.classList.add('open');
  infoModalEl.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  infoCloseBtn.focus();
  trapFocusInModal(infoModalEl);
}
function closeInfoModal() {
  infoModalEl.classList.remove('open');
  infoModalEl.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  if (_lastFocusedElement) _lastFocusedElement.focus();
}
infoButtonEl.addEventListener('click', openInfoModal);
infoButtonEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openInfoModal(); }});
infoCloseBtn.addEventListener('click', closeInfoModal);
infoModalEl.addEventListener('click', (e) => { if (e.target === infoModalEl) closeInfoModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && infoModalEl.classList.contains('open')) closeInfoModal(); });

function trapFocusInModal(modal) {
  const focusableSelector = 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, [tabindex]:not([tabindex="-1"])';
  const focusable = Array.from(modal.querySelectorAll(focusableSelector));
  if (focusable.length === 0) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];
  function handleTrap(e) {
    if (e.key !== 'Tab') return;
    if (e.shiftKey) {
      if (document.activeElement === first) { e.preventDefault(); last.focus(); }
    } else {
      if (document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
  }
  modal.addEventListener('keydown', handleTrap);
  const observer = new MutationObserver(() => {
    if (!modal.classList.contains('open')) {
      modal.removeEventListener('keydown', handleTrap);
      observer.disconnect();
    }
  });
  observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
}
</script>

</body>
</html>
