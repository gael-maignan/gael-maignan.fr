<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Publier une annonce — Annonces</title>
<style>
  :root{--card-bg:#fff;--muted:#666;--danger:#c00}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:24px auto;padding:16px;background:#f7f7fb;color:#222}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .card{background:var(--card-bg);padding:16px;border-radius:8px;border:1px solid rgba(20,20,40,0.04);box-shadow:0 4px 14px rgba(20,20,40,0.04);margin-bottom:12px}
  input,textarea,button,select{width:100%;box-sizing:border-box;font-size:15px;padding:10px;border-radius:6px;border:1px solid #ddd;background:#fff}
  textarea{min-height:100px;resize:vertical}
  button{margin-top:8px;border:0;background:#0a6cff;color:#fff;font-weight:600;cursor:pointer}
  button.secondary{background:#efefef;color:#111}
  button.danger{background:var(--danger)}
  .flex{display:flex;gap:8px}
  .form-row{display:flex;gap:8px}
  .form-row > *{flex:1}
  .muted{color:var(--muted);font-size:13px}
  .error{color:var(--danger)}
  .annonces-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
  .annonce{padding:12px;border-radius:8px;background:#fff;border:1px solid #eee}
  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
  .price{float:right;font-weight:700;color:#0a6cff}
  .controls{display:flex;gap:8px;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  a.link{color:#0a6cff;text-decoration:none}
</style>
</head>
<body>
  <header>
    <div>
      <h1>Publier & gérer mes annonces</h1>
      <div class="small">Tu peux consulter les annonces publiques ci-dessous.</div>
    </div>
    <div class="flex">
      <button id="refreshBtn" class="secondary">Rafraîchir</button>
      <button id="logoutBtn" class="secondary">Se déconnecter</button>
    </div>
  </header>

  <section id="userCard" class="card" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong id="userEmail">—</strong>
        <div class="small" id="userMeta">profil</div>
      </div>
      <div id="meBadge" class="small" style="background:#f3f6ff;padding:6px;border-radius:999px;color:#0a6cff;display:none">c'est vous</div>
    </div>
  </section>

  <section id="createCard" class="card" aria-live="polite">
    <h2 style="margin-top:0">Créer une annonce</h2>
    <label class="sr-only" for="annTitle">Titre</label>
    <input id="annTitle" type="text" placeholder="Titre (ex: Réparation - plomberie)" maxlength="150" />
    <label class="sr-only" for="annDesc">Description</label>
    <textarea id="annDesc" placeholder="Description, disponibilité, détails..."></textarea>

    <div class="form-row">
      <input id="annPrice" placeholder="Prix en euros (ex: 35.00)" inputmode="decimal" />
      <input id="annLocation" placeholder="Localisation (ex: Paris 11)" />
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="createBtn">Publier</button>
      <button id="resetBtn" class="secondary">Réinitialiser</button>
    </div>

    <div id="createError" class="error" role="status" aria-live="polite"></div>
    <div id="createSuccess" class="muted" role="status" aria-live="polite"></div>
  </section>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Annonces publiques</h2>
      <div>
        <input id="filterInput" placeholder="Rechercher titre / description / localisation" style="width:260px;display:inline-block" />
      </div>
    </div>

    <div id="annoncesMsg" class="small muted" style="margin-top:8px">Chargement…</div>
    <div id="annoncesContainer" class="annonces-grid" style="margin-top:12px"></div>
  </section>

<script>
const WORKER_URL = "https://api.gael-maignan.fr";

function el(id){ return document.getElementById(id); }
function centsFromInput(str){
  const v = String(str||"").trim().replace(",",".");
  if (v==="") return null;
  const n = Number(v);
  if (Number.isNaN(n)) return null;
  return Math.round(n*100);
}
function formatPrice(cents){ if (cents===null||cents===undefined) return "—"; return (cents/100).toFixed(2) + " €"; }

// session check -> /user-info (will return id when authenticated)
async function checkSession() {
  try {
    const res = await fetch(`${WORKER_URL}/user-info`, {
      method: "POST",
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({})
    });
    if (res.status === 401) {
      // not authenticated -> redirect to login
      window.location.href = "/login.html";
      return null;
    }
    const info = await res.json();
    // ensure we have id (server must provide it via getCachedUserData)
    if (info && info.id) {
      window.__meId = String(info.id);
      localStorage.setItem("meId", window.__meId);
      el("meBadge").style.display = "inline-block";
    } else {
      window.__meId = localStorage.getItem("meId") || null;
      if (window.__meId) el("meBadge").style.display = "inline-block";
    }
    el("userEmail").innerText = info.username ?? info.email ?? "Utilisateur";
    el("userMeta").innerText = `niveau ${info.level ?? "—"} • xp ${info.xp ?? "—"}`;
    return info;
  } catch (e) {
    console.error("checkSession error", e);
    // on erreur réseau, laisser l'utilisateur sur la page mais afficher message et tenter load annonces publiques
    el("userEmail").innerText = "Erreur réseau (session inconnue)";
    return null;
  }
}

/* CREATE */
el("createBtn").addEventListener("click", async ()=>{
  const title = el("annTitle").value.trim();
  const description = el("annDesc").value.trim();
  const priceInput = el("annPrice").value.trim();
  const location = el("annLocation").value.trim();
  const err = el("createError"), ok = el("createSuccess");
  err.innerText = ""; ok.innerText = "";
  el("createBtn").disabled = true;
  if (!title) { err.innerText = "Titre requis."; el("createBtn").disabled = false; return; }
  const price = centsFromInput(priceInput);
  const payload = { title, description: description||null, price: price, location: location||null };
  try {
    const res = await fetch(`${WORKER_URL}/annonces`, {
      method: "POST",
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if (res.ok) {
      ok.innerText = "Annonce créée.";
      // optimistic append if id returned
      if (data && data.id) {
        appendAnnonceToDOM({
          id: data.id,
          user_id: window.__meId || localStorage.getItem("meId") || "me?",
          title, description, price, location, is_active:1, created_at: Math.floor(Date.now()/1000)
        }, true);
      } else {
        loadAnnonces();
      }
      el("annTitle").value=""; el("annDesc").value=""; el("annPrice").value=""; el("annLocation").value="";
    } else if (res.status === 401) {
      err.innerText = data.error || "Authentification requise.";
      setTimeout(()=>window.location.href="/login.html",800);
    } else {
      err.innerText = data.error || "Erreur creation.";
    }
  } catch (e) {
    console.error("create error", e);
    err.innerText = "Erreur réseau.";
  } finally { el("createBtn").disabled = false; }
});

el("resetBtn").addEventListener("click", ()=>{ el("annTitle").value=""; el("annDesc").value=""; el("annPrice").value=""; el("annLocation").value=""; el("createError").innerText=""; el("createSuccess").innerText=""; });

/* LOGOUT */
el("logoutBtn").addEventListener("click", async ()=>{
  try {
    await fetch(`${WORKER_URL}/logout`, { method:"POST", credentials:"include" });
  } catch(e){ console.warn("logout err", e); }
  localStorage.removeItem("meId");
  window.location.href = "/login.html";
});

/* REFRESH */
el("refreshBtn").addEventListener("click", ()=> loadAnnonces());

/* LOAD ANNONCES (tolerant format handling) */
async function loadAnnonces() {
  const container = el("annoncesContainer");
  const msg = el("annoncesMsg");
  container.innerHTML = "";
  msg.innerText = "Chargement…";
  try {
    const res = await fetch(`${WORKER_URL}/annonces?limit=200`, { method:"GET", credentials:"include" });
    if (!res.ok) { msg.innerText = "Impossible de charger les annonces."; return; }
    const data = await res.json().catch(()=>null);
    // normalize
    let annonces = [];
    if (!data) annonces = [];
    else if (Array.isArray(data.annonces)) annonces = data.annonces;
    else if (data.annonces && Array.isArray(data.annonces.results)) annonces = data.annonces.results;
    else if (Array.isArray(data)) annonces = data;
    else if (Array.isArray(data.results)) annonces = data.results;
    else { for (const k of Object.keys(data)) if (Array.isArray(data[k])) { annonces = data[k]; break; } }

    if (!annonces.length) { msg.innerText = "Aucune annonce publique."; return; }
    msg.innerText = `Affichage ${annonces.length} annonce(s).`;
    container.innerHTML = "";
    const filter = (el("filterInput").value||"").toLowerCase().trim();
    annonces.filter(a=>{
      if (!filter) return true;
      return (a.title||"").toLowerCase().includes(filter) || (a.description||"").toLowerCase().includes(filter) || (a.location||"").toLowerCase().includes(filter);
    }).forEach(a => appendAnnonceToDOM(a, false));
  } catch(e){ console.error("load error", e); el("annoncesMsg").innerText = "Erreur réseau."; }
}
el("filterInput").addEventListener("input", ()=> loadAnnonces());

/* appendAnnonceToDOM: show edit/delete only if owner (ui) */
function appendAnnonceToDOM(a, highlight=false) {
  const container = el("annoncesContainer");
  const card = document.createElement("article");
  card.className = "annonce";
  if (highlight) card.style.boxShadow = "0 8px 30px rgba(10,108,255,0.08)";

  const title = document.createElement("div");
  title.innerHTML = `<strong>${escapeHtml(a.title||"Sans titre")}</strong><span class="price">${formatPrice(a.price)}</span>`;
  card.appendChild(title);

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerText = `par ${a.user_id ?? "inconnu"}${ a.location ? " • "+a.location : "" }`;
  card.appendChild(meta);

  if (a.description) {
    const p = document.createElement("p");
    p.innerText = a.description;
    card.appendChild(p);
  }

  const controls = document.createElement("div");
  controls.className = "controls";

  const myId = window.__meId || localStorage.getItem("meId");

  if (myId && String(a.user_id) === String(myId)) {
    const editBtn = document.createElement("button");
    editBtn.className = "secondary";
    editBtn.innerText = "Modifier";
    editBtn.onclick = ()=> openEditDialog(a);
    controls.appendChild(editBtn);

    const delBtn = document.createElement("button");
    delBtn.className = "danger";
    delBtn.innerText = "Supprimer";
    delBtn.onclick = ()=> deleteAnnonce(a.id, card);
    controls.appendChild(delBtn);
  } else {
    const contactBtn = document.createElement("button");
    contactBtn.className = "secondary";
    contactBtn.innerText = "Contacter";
    contactBtn.onclick = ()=> alert("Fonction de contact non implémentée (placeholder).");
    controls.appendChild(contactBtn);
  }

  card.appendChild(controls);
  container.prepend(card);
}

/* edit via prompt (minimal) */
async function openEditDialog(a) {
  const newTitle = prompt("Titre", a.title || "");
  if (newTitle === null) return;
  const newDesc = prompt("Description", a.description || "") ?? "";
  const newPrice = prompt("Prix en euros (ex: 35.00) — laisser vide pour ne pas changer", a.price ? (a.price/100).toFixed(2) : "");
  const newLocation = prompt("Localisation", a.location || "") ?? "";

  const payload = {};
  if (newTitle !== undefined && newTitle !== a.title) payload.title = newTitle;
  if (newDesc !== undefined && newDesc !== a.description) payload.description = newDesc;
  if (newLocation !== undefined && newLocation !== a.location) payload.location = newLocation;
  if (newPrice !== null && String(newPrice).trim() !== "") {
    const cents = centsFromInput(newPrice);
    if (cents === null) { alert("Prix invalide"); return; }
    payload.price = cents;
  }
  if (Object.keys(payload).length === 0) { alert("Aucune modification détectée."); return; }

  try {
    const res = await fetch(`${WORKER_URL}/annonces/${a.id}`, {
      method: "PATCH",
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (res.ok) { alert("Annonce mise à jour."); loadAnnonces(); }
    else if (res.status === 403) { const d=await res.json().catch(()=>({})); alert(d.error||"Forbidden"); }
    else if (res.status === 401) { alert("Authentification requise."); window.location.href="/login.html"; }
    else { const d=await res.json().catch(()=>({})); alert(d.error||"Erreur"); }
  } catch(e){ console.error("edit err", e); alert("Erreur réseau."); }
}

/* delete: server enforces owner check */
async function deleteAnnonce(id, domNode) {
  if (!confirm("Confirmer la suppression (soft-delete) ?")) return;
  try {
    const res = await fetch(`${WORKER_URL}/annonces/${id}`, { method:"DELETE", credentials:"include" });
    if (res.ok) {
      if (domNode && domNode.parentNode) domNode.parentNode.removeChild(domNode);
      else loadAnnonces();
    } else if (res.status === 403) { const d=await res.json().catch(()=>({})); alert(d.error||"Interdit"); }
    else if (res.status === 401) { alert("Authentification requise."); window.location.href="/login.html"; }
    else { const d=await res.json().catch(()=>({})); alert(d.error||"Erreur suppression"); }
  } catch(e){ console.error("delete err", e); alert("Erreur réseau."); }
}

/* utilities */
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* bootstrap */
(async function init(){
  await checkSession(); // redirects to login if not authenticated
  await loadAnnonces();
})();
</script>
</body>
</html>