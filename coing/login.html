<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Connexion — Annonces</title>
<style>
  :root{--card-bg:#fff;--muted:#666;--danger:#c00}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:480px;margin:40px auto;padding:0 16px;background:#f7f7fb;color:#222}
  .card{background:var(--card-bg);padding:18px;border-radius:8px;border:1px solid rgba(20,20,40,0.04);box-shadow:0 4px 14px rgba(20,20,40,0.04)}
  h1{font-size:18px;margin:0 0 8px}
  input,button{width:100%;box-sizing:border-box;font-size:15px;padding:10px;border-radius:6px;border:1px solid #ddd;background:#fff}
  button{margin-top:10px;border:0;background:#0a6cff;color:#fff;font-weight:600;cursor:pointer}
  .secondary{background:#efefef;color:#111}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  .error{color:var(--danger);margin-top:8px}
  .row{display:flex;gap:8px}
  .row button{flex:1}
</style>
</head>
<body>
  <main class="card" aria-live="polite">
    <h1>Se connecter</h1>
    <p class="muted">Accède à l'espace de publication d'annonces.</p>

    <label class="sr-only" for="username">Email</label>
    <input id="username" type="email" placeholder="email" autocomplete="username" value="contact@gael-maignan.fr" />

    <label class="sr-only" for="password">Mot de passe</label>
    <input id="password" type="password" placeholder="mot de passe" autocomplete="current-password" value="password" />

    <div class="row" style="margin-top:8px">
      <button id="loginBtn">Se connecter</button>
    </div>

    <div id="loginError" class="error" role="status" aria-live="polite"></div>

    <a class="muted" style="margin-top:12px" href="register.html">Créer un compte</a>
  </main>

<script>
const WORKER_URL = "https://api.gael-maignan.fr";

function el(id){ return document.getElementById(id); }

/**
 * Vérifie la session côté serveur en envoyant les cookies (credentials: "include").
 * Si la session est valide, on stocke l'id si disponible et on redirige vers mes-annonces.html.
 * En cas d'erreur réseau ou 401 on reste sur la page de login.
 */
async function checkAuthOnLoad(){
  try {
    // petit hint visuel optionnel (décommenter si souhaité)
    // el("loginError").innerText = "Vérification de la session…";

    const res = await fetch(`${WORKER_URL}/user-info`, {
      method: "POST",
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      body: "{}"
    });

    if (res.ok) {
      // session valide -> récupérer info (si renvoyée) et rediriger
      const info = await res.json().catch(()=>null);
      if (info && info.id) {
        localStorage.setItem("meId", String(info.id));
      }
      // redirection vers la page de gestion des annonces
      window.location.href = "mes-annonces.html";
      return;
    }

    // 401 ou autre -> ne rien faire (utilisateur non connecté)
    // if (res.status === 401) { /* pas connecté */ }
  } catch (e) {
    // échec réseau : on reste sur la page de login (on ne bloque pas l'UI)
    console.warn("Échec vérification session:", e);
  } finally {
    // retirer le message de vérification si utilisé
    // if (el("loginError").innerText === "Vérification de la session…") el("loginError").innerText = "";
  }
}

/* Handler du bouton login (conserve le comportement existant) */
el("loginBtn").addEventListener("click", async (e)=>{
  const username = el("username").value.trim();
  const password = el("password").value;
  const err = el("loginError");
  err.innerText = "";
  el("loginBtn").disabled = true;

  if (!username || !password) {
    err.innerText = "Email et mot de passe requis.";
    el("loginBtn").disabled = false;
    return;
  }

  try {
    const res = await fetch(`${WORKER_URL}/login`, {
      method: "POST",
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username, password })
    });

    const data = await res.json().catch(()=>({}));

    if (res.ok && data.success) {
      // store id locally if backend returned it
      if (data.user && data.user.id) {
        localStorage.setItem("meId", String(data.user.id));
      }
      // redirect to annonces page
      window.location.href = "mes-annonces.html";
    } else if (res.status === 401) {
      err.innerText = "Identifiants incorrects.";
    } else {
      err.innerText = data.error || "Erreur lors de la connexion.";
    }
  } catch (e) {
    console.error("login error", e);
    err.innerText = "Erreur réseau / serveur.";
  } finally {
    el("loginBtn").disabled = false;
  }
});

/* Lancer la vérification au chargement de la page */
document.addEventListener("DOMContentLoaded", () => {
  checkAuthOnLoad();
});
</script>
</body>
</html>