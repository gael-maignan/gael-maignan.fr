<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mes annonces</title>

<style>
:root{--card-bg:#fff;--muted:#666;--danger:#c00}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:24px auto;padding:16px;background:#f7f7fb;color:#222}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
h1{font-size:18px;margin:0}
.card{background:#fff;padding:16px;border-radius:8px;border:1px solid rgba(20,20,40,0.04);box-shadow:0 4px 14px rgba(20,20,40,0.04);margin-bottom:12px}
input,textarea,button{width:100%;box-sizing:border-box;font-size:15px;padding:10px;border-radius:6px;border:1px solid #ddd}
textarea{min-height:100px;resize:vertical}
button{margin-top:8px;border:0;background:#0a6cff;color:#fff;font-weight:600;cursor:pointer}
button.secondary{background:#efefef;color:#111}
button.danger{background:var(--danger)}
.annonces-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
.annonce{padding:12px;border-radius:8px;background:#fff;border:1px solid #eee}
.meta{font-size:13px;color:#666;margin-bottom:6px}
.price{float:right;font-weight:700;color:#0a6cff}
.controls{display:flex;gap:8px;margin-top:10px}
.small{font-size:13px;color:#666}
.error{color:#c00}
</style>
</head>

<body>

<header>
  <div>
    <h1>Mes annonces</h1>
    <div class="small">Gestion de vos annonces uniquement</div>
  </div>
  <div>
    <button id="refreshBtn" class="secondary">Rafraîchir</button>
    <button id="logoutBtn" class="secondary">Se déconnecter</button>
  </div>
</header>

<section class="card">
  <strong id="userEmail">—</strong>
  <div class="small" id="userMeta"></div>
</section>

<section class="card">
  <h2>Créer une annonce</h2>
  <input id="annTitle" placeholder="Titre" maxlength="150">
  <textarea id="annDesc" placeholder="Description"></textarea>
  <input id="annPrice" placeholder="Prix (ex: 35.00)">
  <input id="annLocation" placeholder="Localisation">
  <button id="createBtn">Publier</button>
  <div id="createError" class="error"></div>
</section>

<section class="card">
  <h2>Vos annonces</h2>
  <div id="annoncesMsg" class="small">Chargement…</div>
  <div id="annoncesContainer" class="annonces-grid"></div>
</section>

<script>
const WORKER_URL = "https://api.gael-maignan.fr";

function el(id){ return document.getElementById(id); }
function cents(str){ const n = Number(String(str||"").replace(",", ".")); return isNaN(n)?null:Math.round(n*100); }
function price(c){ return c!=null?(c/100).toFixed(2)+" €":"—"; }

/* helper: safe escape pour HTML */
function escapeHtml(s){return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* helper: convert timestamp (s or ms) en chaîne locale FR */
function tsToDate(ts){
  if(ts==null) return "";
  const n = Number(ts);
  if(isNaN(n)) return String(ts);
  const ms = n > 1e12 ? n : n * 1000; // détecte secondes vs ms
  return new Date(ms).toLocaleString('fr-FR');
}

/* SESSION */
async function checkSession(){
  try{
    const res = await fetch(`${WORKER_URL}/user-info`,{
      method:"POST",
      credentials:"include",
      headers:{"Content-Type":"application/json"},
      body:"{}"
    });

    if(res.status===401){
      location.href="login.html";
      return;
    }

    const info = await res.json();
    window.__meId = String(info.id);
    localStorage.setItem("meId", window.__meId);

    el("userEmail").innerText = info.username ?? info.email ?? "Utilisateur";
    el("userMeta").innerText = `niveau ${info.level ?? "-"} • xp ${info.xp ?? "-"}`;
  }catch(err){
    console.error("Erreur session:", err);
    el("userEmail").innerText="Erreur session";
  }
}

/* LOAD UNIQUEMENT MES ANNONCES */
async function loadAnnonces(){
  const container = el("annoncesContainer");
  const msg = el("annoncesMsg");
  container.innerHTML="";
  msg.innerText="Chargement…";

  const myId = window.__meId || localStorage.getItem("meId");
  if(!myId){ msg.innerText="Utilisateur inconnu."; return; }

  let res;
  try{
    res = await fetch(`${WORKER_URL}/annonces?limit=200`,{
      credentials:"include"
    });
  }catch(err){
    console.error(err);
    msg.innerText="Erreur réseau.";
    return;
  }

  if(!res.ok){ msg.innerText="Erreur chargement."; return; }

  let data;
  try{
    data = await res.json();
  }catch(err){
    console.error("JSON parse error:", err);
    msg.innerText="Réponse API invalide.";
    return;
  }

  // Normaliser les différentes formes possibles de la réponse API
  let annonces = [];

  if (Array.isArray(data)) {
    annonces = data;
  } else if (data && Array.isArray(data.results)) {
    annonces = data.results;
  } else if (data && data.annonces) {
    if (Array.isArray(data.annonces)) {
      annonces = data.annonces;
    } else if (Array.isArray(data.annonces.results)) {
      annonces = data.annonces.results;
    } else if (Array.isArray(data.annonces.data)) {
      annonces = data.annonces.data;
    }
  } else if (data && Array.isArray(data.data)) {
    annonces = data.data;
  } else {
    console.error("Réponse API inattendue :", data);
    annonces = [];
  }

  // Filtrage strict par user_id
  annonces = annonces.filter(a => String(a.user_id) === String(myId));

  if(!annonces.length){
    msg.innerText="Vous n'avez aucune annonce.";
    return;
  }

  msg.innerText=`${annonces.length} annonce(s)`;

  // tri optionnel: par created_at descendant si disponible
  annonces.sort((a,b)=>{
    const ta = Number(a.created_at) || 0;
    const tb = Number(b.created_at) || 0;
    return tb - ta;
  });

  annonces.forEach(a=>{
    const card=document.createElement("article");
    card.className="annonce";

    // normaliser prix (l'API peut renvoyer null, number en cents, string en euros, etc.)
    let priceCents = null;
    if (a.price != null) {
      if (typeof a.price === 'number') {
        // on suppose que l'API renvoie en centimes (ou en euros si <10000? difficile à deviner)
        // si le nombre semble petit (<1000) on le traite comme euros -> convertir en centimes
        priceCents = a.price > 10000 ? a.price : (a.price < 1000 ? Math.round(a.price*100) : a.price);
      } else if (typeof a.price === 'string' && a.price.trim() !== '') {
        const maybe = Number(a.price.replace(",", "."));
        if (!isNaN(maybe)) priceCents = Math.round(maybe*100);
      }
    }

    const locationText = a.location ?? "";
    const created = tsToDate(a.created_at);

    card.innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong>${escapeHtml(a.title||"—")}</strong>
        <span class="price">${price(priceCents)}</span>
      </div>
      <div class="meta">${escapeHtml(locationText)} ${created?(" • "+escapeHtml(created)):""}</div>
      <p>${escapeHtml(a.description||"")}</p>
    `;

    const controls=document.createElement("div");
    controls.className="controls";

    const edit=document.createElement("button");
    edit.className="secondary";
    edit.innerText="Modifier";
    edit.onclick=()=>editAnnonce(a);

    const del=document.createElement("button");
    del.className="danger";
    del.innerText="Supprimer";
    del.onclick=()=>deleteAnnonce(a.id);

    controls.append(edit,del);
    card.appendChild(controls);
    container.appendChild(card); // append pour conserver l'ordre trié ci-dessus
  });
}

/* CREATE */
el("createBtn").onclick=async()=>{
  el("createError").innerText="";

  const payload={
    title:el("annTitle").value.trim(),
    description:el("annDesc").value.trim(),
    price:cents(el("annPrice").value),
    location:el("annLocation").value.trim()
  };

  if(!payload.title){ el("createError").innerText="Titre requis."; return; }

  try{
    const res=await fetch(`${WORKER_URL}/annonces`,{
      method:"POST",
      credentials:"include",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    if(res.ok){
      el("annTitle").value="";
      el("annDesc").value="";
      el("annPrice").value="";
      el("annLocation").value="";
      await loadAnnonces();
    }else{
      const errText = await res.text().catch(()=>"");
      el("createError").innerText="Erreur création." + (errText?(" "+errText):"");
    }
  }catch(err){
    console.error("Erreur création:", err);
    el("createError").innerText="Erreur réseau lors de la création.";
  }
};

/* DELETE */
async function deleteAnnonce(id){
  if(!confirm("Confirmer suppression ?")) return;
  try{
    const res=await fetch(`${WORKER_URL}/annonces/${id}`,{
      method:"DELETE",
      credentials:"include"
    });
    if(res.ok) loadAnnonces();
    else alert("Erreur suppression");
  }catch(err){
    console.error("Erreur suppression:", err);
    alert("Erreur réseau");
  }
}

/* EDIT (simple) */
async function editAnnonce(a){
  const t=prompt("Titre",a.title);
  if(t===null) return;
  try{
    await fetch(`${WORKER_URL}/annonces/${a.id}`,{
      method:"PATCH",
      credentials:"include",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({title:t})
    });
    loadAnnonces();
  }catch(err){
    console.error("Erreur modification:", err);
    alert("Erreur modification");
  }
}

el("refreshBtn").onclick=loadAnnonces;
el("logoutBtn").onclick=async()=>{
  await fetch(`${WORKER_URL}/logout`,{method:"POST",credentials:"include"});
  localStorage.removeItem("meId");
  location.href="login.html";
};

function price(c){ return c!=null?(c/100).toFixed(2)+" €":"—"; }

(async()=>{
  await checkSession();
  await loadAnnonces();
})();
</script>

</body>
</html>